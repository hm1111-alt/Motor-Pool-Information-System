<!DOCTYPE html>
<html>
<head>
    <title>Working Cascading Dropdowns</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-800">✅ Working Cascading Dropdowns</h1>
        <p class="text-center text-gray-600 mb-6">Office → Division → Unit → Subunit</p>
        
        <div class="space-y-4">
            <!-- Office Dropdown -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Office *</label>
                <select id="officeSelect" class="w-full rounded-lg border-gray-300 p-2 focus:ring-2 focus:ring-green-500">
                    <option value="">Loading offices...</option>
                </select>
            </div>
            
            <!-- Division Dropdown -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Division *</label>
                <select id="divisionSelect" class="w-full rounded-lg border-gray-300 p-2 focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">Select Office first</option>
                </select>
            </div>
            
            <!-- Unit Dropdown -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Unit *</label>
                <select id="unitSelect" class="w-full rounded-lg border-gray-300 p-2 focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">Select Division first</option>
                </select>
            </div>
            
            <!-- Subunit Dropdown -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subunit</label>
                <select id="subunitSelect" class="w-full rounded-lg border-gray-300 p-2 focus:ring-2 focus:ring-green-500" disabled>
                    <option value="">Select Unit first</option>
                </select>
            </div>
        </div>
        
        <!-- Selection Path -->
        <div class="mt-6 p-4 bg-green-50 rounded border border-green-200">
            <h2 class="font-bold mb-2 text-green-800">Your Selection Path:</h2>
            <div id="selectionPath" class="text-green-700">
                No selections made yet
            </div>
        </div>
        
        <!-- Debug Info -->
        <details class="mt-4">
            <summary class="cursor-pointer text-sm text-gray-500">Debug Information</summary>
            <div id="debugInfo" class="mt-2 text-xs font-mono p-2 bg-gray-100 rounded"></div>
        </details>
    </div>

    <script>
        // Global data storage
        let allData = {
            offices: [],
            divisions: {},
            units: {},
            subunits: {}
        };
        
        function debug(message) {
            const debugEl = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML += `[${timestamp}] ${message}\n`;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(message);
        }
        
        function updateSelectionPath() {
            const officeSel = document.getElementById('officeSelect');
            const divisionSel = document.getElementById('divisionSelect');
            const unitSel = document.getElementById('unitSelect');
            const subunitSel = document.getElementById('subunitSelect');
            const pathEl = document.getElementById('selectionPath');
            
            const path = [];
            if (officeSel.value && officeSel.options[officeSel.selectedIndex]) {
                path.push(officeSel.options[officeSel.selectedIndex].text);
            }
            if (divisionSel.value && divisionSel.options[divisionSel.selectedIndex]) {
                path.push(divisionSel.options[divisionSel.selectedIndex].text);
            }
            if (unitSel.value && unitSel.options[unitSel.selectedIndex]) {
                path.push(unitSel.options[unitSel.selectedIndex].text);
            }
            if (subunitSel.value && subunitSel.options[subunitSel.selectedIndex]) {
                path.push(subunitSel.options[subunitSel.selectedIndex].text);
            }
            
            pathEl.innerHTML = path.length > 0 ? 
                path.join(' → ') : 'No selections made yet';
        }
        
        function enableDropdown(id, enable) {
            const el = document.getElementById(id);
            el.disabled = !enable;
            if (!enable) {
                const labels = {
                    'divisionSelect': 'Select Office first',
                    'unitSelect': 'Select Division first',
                    'subunitSelect': 'Select Unit first'
                };
                el.innerHTML = `<option value="">${labels[id] || 'Select parent first'}</option>`;
            }
        }
        
        // Load all data at once
        document.addEventListener('DOMContentLoaded', async function() {
            debug('Starting data loading...');
            
            try {
                // Load offices
                debug('Loading offices...');
                const officeResponse = await fetch('/api/offices');
                if (!officeResponse.ok) throw new Error('Failed to load offices');
                allData.offices = await officeResponse.json();
                debug(`Loaded ${allData.offices.length} offices`);
                
                // Load divisions for all offices
                debug('Loading divisions...');
                for (const office of allData.offices) {
                    try {
                        const divResponse = await fetch(`/test/ajax/divisions/${office.id}`);
                        if (divResponse.ok) {
                            allData.divisions[office.id] = await divResponse.json();
                            debug(`Office ${office.id}: ${allData.divisions[office.id].length} divisions`);
                        }
                    } catch (e) {
                        debug(`Error loading divisions for office ${office.id}: ${e.message}`);
                        allData.divisions[office.id] = [];
                    }
                }
                
                // Load units for all divisions
                debug('Loading units...');
                for (const [officeId, divisions] of Object.entries(allData.divisions)) {
                    for (const division of divisions) {
                        try {
                            const unitResponse = await fetch(`/test/ajax/units/${division.id_division}`);
                            if (unitResponse.ok) {
                                allData.units[division.id_division] = await unitResponse.json();
                                debug(`Division ${division.id_division}: ${allData.units[division.id_division].length} units`);
                            }
                        } catch (e) {
                            debug(`Error loading units for division ${division.id_division}: ${e.message}`);
                            allData.units[division.id_division] = [];
                        }
                    }
                }
                
                // Load subunits for all units
                debug('Loading subunits...');
                for (const [divisionId, units] of Object.entries(allData.units)) {
                    for (const unit of units) {
                        try {
                            const subResponse = await fetch(`/test/ajax/subunits/${unit.id_unit}`);
                            if (subResponse.ok) {
                                allData.subunits[unit.id_unit] = await subResponse.json();
                                debug(`Unit ${unit.id_unit}: ${allData.subunits[unit.id_unit].length} subunits`);
                            }
                        } catch (e) {
                            debug(`Error loading subunits for unit ${unit.id_unit}: ${e.message}`);
                            allData.subunits[unit.id_unit] = [];
                        }
                    }
                }
                
                // Populate office dropdown
                const officeSelect = document.getElementById('officeSelect');
                officeSelect.innerHTML = '<option value="">Select Office</option>';
                allData.offices.forEach(office => {
                    officeSelect.innerHTML += `<option value="${office.id}">${office.office_name}</option>`;
                });
                
                debug('All data loaded successfully!');
                
            } catch (error) {
                debug(`FATAL ERROR: ${error.message}`);
                document.getElementById('officeSelect').innerHTML = 
                    '<option value="">Error loading data</option>';
            }
            
            // Set up event listeners
            document.getElementById('officeSelect').addEventListener('change', function() {
                const officeId = this.value;
                debug(`Office selected: ${officeId}`);
                
                // Reset dependent dropdowns
                enableDropdown('divisionSelect', false);
                enableDropdown('unitSelect', false);
                enableDropdown('subunitSelect', false);
                updateSelectionPath();
                
                if (officeId && allData.divisions[officeId]) {
                    debug(`Populating divisions for office ${officeId}`);
                    enableDropdown('divisionSelect', true);
                    
                    const divSelect = document.getElementById('divisionSelect');
                    divSelect.innerHTML = '<option value="">Select Division</option>';
                    allData.divisions[officeId].forEach(division => {
                        divSelect.innerHTML += `<option value="${division.id_division}">${division.division_name}</option>`;
                    });
                }
            });
            
            document.getElementById('divisionSelect').addEventListener('change', function() {
                const divisionId = this.value;
                debug(`Division selected: ${divisionId}`);
                
                // Reset dependent dropdowns
                enableDropdown('unitSelect', false);
                enableDropdown('subunitSelect', false);
                updateSelectionPath();
                
                if (divisionId && allData.units[divisionId]) {
                    debug(`Populating units for division ${divisionId}`);
                    enableDropdown('unitSelect', true);
                    
                    const unitSelect = document.getElementById('unitSelect');
                    unitSelect.innerHTML = '<option value="">Select Unit</option>';
                    allData.units[divisionId].forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id_unit}">${unit.unit_name}</option>`;
                    });
                }
            });
            
            document.getElementById('unitSelect').addEventListener('change', function() {
                const unitId = this.value;
                debug(`Unit selected: ${unitId}`);
                
                // Reset dependent dropdown
                enableDropdown('subunitSelect', false);
                updateSelectionPath();
                
                if (unitId && allData.subunits[unitId]) {
                    debug(`Populating subunits for unit ${unitId}`);
                    enableDropdown('subunitSelect', true);
                    
                    const subSelect = document.getElementById('subunitSelect');
                    subSelect.innerHTML = '<option value="">Select Subunit</option>';
                    allData.subunits[unitId].forEach(subunit => {
                        subSelect.innerHTML += `<option value="${subunit.id_subunit}">${subunit.subunit_name}</option>`;
                    });
                }
            });
            
            document.getElementById('subunitSelect').addEventListener('change', function() {
                debug(`Subunit selected: ${this.value}`);
                updateSelectionPath();
            });
        });
    </script>
</body>
</html>